<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>๐ เบฅเบฒเบเบเบฒเบเบเบญเบเบเบฒเบ & Stock</title>

<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h2 class="report-header">๐ เปเบเบเบเบญเบเบฅเบฒเบเบเบฒเบเบเบญเบเบเบฒเบ & Stock</h2>

<!-- TOOLBAR -->
<div class="report-toolbar modern-toolbar">

  <button class="btn back big" onclick="location.href='index.html'">
    โฌ เบเบฑเบเปเปเบฒเบเบฒเบ
  </button>

  <div class="filter card">
    <label>๐ เบงเบฑเบเบเบตเปเบฅเบตเปเบก</label>
    <input type="date" id="startDate">
  </div>

  <div class="filter card">
    <label>๐ เบงเบฑเบเบเบตเบชเบดเปเบเบชเบธเบ</label>
    <input type="date" id="endDate">
  </div>

  <button class="btn primary big" onclick="loadReport()">๐ เบชเบฐเปเบเบเบฅเบฒเบเบเบฒเบ</button>
  <button class="btn success big" onclick="exportCSV()">๐ฅ Export</button>

</div>

<!-- DASHBOARD GRID -->
<div class="report-dashboard">

  <!-- SALES CHART -->
  <div class="dash-card">
    <h3>๐ เบเบญเบเบเบฒเบเบฅเบฒเบเบงเบฑเบ (เบเบตเบ)</h3>
    <canvas id="salesChart" height="120"></canvas>
  </div>

  <!-- STOCK CHART -->
  <div class="dash-card">
    <h3>๐ฆ Stock เบเบปเบเปเบซเบผเบทเบญ</h3>
    <canvas id="stockChart" height="120"></canvas>
  </div>

  <!-- CATEGORY -->
  <div class="dash-card">
    <h3>๐ เบเบญเบเบเบฒเบเบเบฒเบกเปเบงเบ (เบเบตเบ)</h3>
    <div id="categorySummary" class="summary-grid"></div>
  </div>

  <!-- PRODUCT SUMMARY -->
  <div class="dash-card">
    <h3>๐ฅ เบเบฒเบเบเบต / Stock</h3>
    <div id="productSummary" class="summary-grid"></div>
  </div>

</div>

<!-- TABLE -->
<div class="report-box modern-table">

  <h3>๐งพ เบฅเบฒเบเบฅเบฐเบญเบฝเบเบเบฒเบเบเบฒเบ</h3>

  <table class="report-table">
    <thead>
      <tr>
        <th>เบงเบฑเบเบเบต / เปเบงเบฅเบฒ</th>
        <th>เบเบญเบเบเบฒเบ (เบเบตเบ)</th>
      </tr>
    </thead>
    <tbody id="report"></tbody>
  </table>

  <div class="report-total" id="reportTotal"></div>
</div>

<script>
let sales    = JSON.parse(localStorage.getItem("sales") || "[]");
let products = JSON.parse(localStorage.getItem("products") || "[]");

let salesChart = null;
let stockChart = null;

/* =====================
   เธเธณเธเธงเธ stock เธเธเนเธซเธฅเธทเธญ
===================== */
function getStockRemain(p){
  return (p.stockIn || 0) - (p.sold || 0);
}

/* =====================
   LOAD REPORT
===================== */
function loadReport(){
  const start = startDate.value;
  const end   = endDate.value;

  if(!start || !end){
    alert("เบเบฐเบฅเบธเบเบฒเปเบฅเบทเบญเบเบเปเบงเบเบงเบฑเบเบเบต");
    return;
  }

  const startTime = new Date(start).getTime();
  const endTime   = new Date(end).getTime() + 86400000;

  let totalKIP = 0;
  let html = "";

  const list = sales.filter(s=>{
    const t = new Date(s.date).getTime();
    return t >= startTime && t <= endTime;
  });

  if(list.length === 0){
    report.innerHTML = `
      <tr>
        <td colspan="2" style="text-align:center;">เบเปเปเบกเบตเบเปเปเบกเบนเบ</td>
      </tr>
    `;
    reportTotal.innerHTML = "";
    return;
  }

  list.forEach(s=>{
    totalKIP += s.total;

    html += `
      <tr>
        <td>${new Date(s.date).toLocaleString()}</td>
        <td>
          <b>${s.total.toLocaleString()} เบเบตเบ</b>
        </td>
      </tr>
    `;
  });

  report.innerHTML = html;

  reportTotal.innerHTML = `
    ๐ฐ เบฅเบงเบกเบเบฑเบเปเบปเบ:
    <b>${totalKIP.toLocaleString()} เบเบตเบ</b>
  `;

  drawSalesChart(list);
  drawStockChart();
  renderCategorySummary(list);
  renderProductSummary();
}

/* =====================
   SALES CHART
===================== */
function drawSalesChart(list){
  const daily = {};

  list.forEach(s=>{
    const day = s.date.substring(0,10);
    daily[day] = (daily[day] || 0) + s.total;
  });

  const labels = Object.keys(daily);
  const values = Object.values(daily);

  if(salesChart) salesChart.destroy();

  salesChart = new Chart(
    document.getElementById("salesChart"),{
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "เบเบญเบเบเบฒเบ (เบเบตเบ)",
          data: values
        }]
      }
    }
  );
}

/* =====================
   STOCK CHART
===================== */
function drawStockChart(){
  const labels = products.map(p=>p.name);
  const values = products.map(p=>getStockRemain(p));

  if(stockChart) stockChart.destroy();

  stockChart = new Chart(
    document.getElementById("stockChart"),{
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Stock เบเบปเบเปเบซเบผเบทเบญ",
          data: values
        }]
      }
    }
  );
}

/* =====================
   CATEGORY SUMMARY
===================== */
function renderCategorySummary(list){
  const cat = {};

  list.forEach(s=>{
    if(!s.items) return;

    s.items.forEach(i=>{
      const name = i.category || "เบญเบทเปเบเป";
      cat[name] = (cat[name] || 0) + (i.price * i.qty);
    });
  });

  let html = "";
  for(const k in cat){
    html += `
      <div class="summary-card">
        <div>${k}</div>
        <b>${cat[k].toLocaleString()} เบเบตเบ</b>
      </div>
    `;
  }

  categorySummary.innerHTML = html;
}

/* =====================
   PRODUCT SUMMARY
===================== */
function renderProductSummary(){
  let html = "";

  products.forEach(p=>{
    html += `
      <div class="summary-card blue">
        <b>${p.name}</b><br>
        ๐ฅ เบเบฒเบเปเบฅเปเบง: ${p.sold || 0}<br>
        ๐ฆ Stock: ${getStockRemain(p)}
      </div>
    `;
  });

  productSummary.innerHTML = html;
}

/* =====================
   EXPORT CSV (KIP)
===================== */
function exportCSV(){
  const start = startDate.value;
  const end   = endDate.value;

  if(!start || !end){
    alert("เปเบฅเบทเบญเบเบงเบฑเบเบเบตเบเปเบญเบ Export");
    return;
  }

  const startTime = new Date(start).getTime();
  const endTime   = new Date(end).getTime() + 86400000;

  const list = sales.filter(s=>{
    const t = new Date(s.date).getTime();
    return t >= startTime && t <= endTime;
  });

  if(list.length === 0){
    alert("เบเปเปเบกเบตเบเปเปเบกเบนเบ");
    return;
  }

  let csv = "Date,Total(KIP)\n";
  list.forEach(s=>{
    csv += `${s.date},${s.total}\n`;
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sales_report_kip.csv";
  a.click();
}
</script>

</body>
</html>